<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Basic Dictionary (sql.js)</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;}
.container{max-width:800px;margin:0 auto;}
h1{font-size:1.4rem;}
form{margin-top:12px;display:flex;gap:8px;}
input[type="text"]{flex:1;padding:8px;font-size:1rem;}
button{padding:8px 12px;font-size:1rem;}
#info{margin-top:12px;color:#666;}
#definition{margin-top:18px;padding:12px;border-radius:6px;white-space:pre-wrap;}
#error{margin-top:12px;color:#b00020;}
.meta{font-size:0.9rem;color:#444;margin-top:8px;}
.defH{margin:0;}
.defP{margin:0;}
#progress-container {
  width: 100%;
  margin-top: 12px;
}
#progress-bar {
  width: 100%;
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 8px;
}
#progress-fill {
  height: 100%;
  background-color: #4caf50;
  width: 0%;
  transition: width 0.3s ease;
  border-radius: 10px;
}
#progress-text {
  text-align: center;
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 12px;
}
</style>
</head>
<body>
<div class="container">
<h1>Basic Dictionary (sql.js + words.db)</h1>
<p>Type a word and press Search. This page loads <code>words.db</code> using sql.js in the browser — run it from a local or static server (e.g. <code>python -m http.server</code>).</p>
<form id="searchForm">
<input id="query" type="text" placeholder="Enter a word" autocomplete="off" required />
<button type="submit">Search</button>
</form>
<div id="info">Loading database...</div>
<div id="progress-container" style="display: none; margin-top: 12px;">
  <div id="progress-bar">
    <div id="progress-fill"></div>
  </div>
  <div id="progress-text">0%</div>
</div>
<div id="error" role="alert" aria-live="assertive"></div>
<h2 id="wordTitle"></h2>
<ol id="definition" aria-live="polite"></ol>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
<script>
(async function(){
  // Ensure initSqlJs is available (sql-wasm.js must load first - we include it above)
  const SQL = await initSqlJs({
    locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.wasm'
  });

  const infoEl = document.getElementById('info');
  const errorEl = document.getElementById('error');
  const defEl = document.getElementById('definition');
  const progressContainer = document.getElementById('progress-container');
  const progressFill = document.getElementById('progress-fill');
  const progressText = document.getElementById('progress-text');
  let db = null;

  function updateProgress(loaded, total) {
    const percent = total ? (loaded / total) * 100 : 0;
    progressFill.style.width = percent + '%';
    progressText.textContent = Math.round(percent) + '%';
  }

  try {
    infoEl.textContent = 'Fetching words.db...';
    progressContainer.style.display = 'block';
    updateProgress(0, 0);

    const res = await fetch('wordnetFull.db');
    if (!res.ok) throw new Error('Failed to fetch words.db: ' + res.status);

    const contentLength = res.headers.get('content-length');
    const total = contentLength ? parseInt(contentLength, 10) : 0;
    let loaded = 0;

    const reader = res.body.getReader();
    const chunks = [];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      chunks.push(value);
      loaded += value.length;
      updateProgress(loaded, total);
    }

    const buffer = new Uint8Array(loaded);
    let offset = 0;
    for (const chunk of chunks) {
      buffer.set(chunk, offset);
      offset += chunk.length;
    }

    db = new SQL.Database(buffer);
    infoEl.textContent = 'Database loaded.';
    progressContainer.style.display = 'none';
  } catch (e) {
    infoEl.textContent = '';
    progressContainer.style.display = 'none';
    errorEl.textContent = 'Error loading database: ' + e.message;
    console.error(e);
    return;
  }

  // Minimal search implementation tailored for a "words" table (word, type, definitions)
  const tableName = 'words';

  // prepare statements (case-insensitive) — fetch all matching rows (no LIMIT)
  const stmtExact = db.prepare(`SELECT word, pos, definition FROM "${tableName}" WHERE lower(word) = $w;`);
  const stmtLike  = db.prepare(`SELECT word, pos, definition FROM "${tableName}" WHERE lower(word) LIKE $p;`);

  function escapeHtml(str){
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&')
      .replace(/</g, '<')
      .replace(/>/g, '>')
      .replace(/"/g, '"')
      .replace(/'/g, '&#039;');
  }

  function renderRows(rows){
    if(!rows || rows.length===0) return '';
    return rows.map(row=>{
      return `<li class="defP"><span><strong>${row['pos']}.</strong> ${escapeHtml(row['definition'])}</span></li>`;
    }).join('\n');
  }

  document.getElementById('searchForm').addEventListener('submit', function(e){
    e.preventDefault();
    errorEl.textContent = '';
    defEl.innerHTML = '';
    const q = document.getElementById('query').value.trim();
    if (!q) return;
    infoEl.textContent = 'Searching...';

    try {
      const rows = [];
      stmtExact.bind({$w: q.toLowerCase()});
      while(stmtExact.step()){
        rows.push(stmtExact.getAsObject());
      }
      stmtExact.reset();

      if(rows.length === 0){
        stmtLike.bind({$p: q.toLowerCase() + '%'});
        while(stmtLike.step()){
          rows.push(stmtLike.getAsObject());
        }
        stmtLike.reset();
      }

      defEl.innerHTML = renderRows(rows);
      infoEl.textContent = '';
      if(rows.length === 0) infoEl.textContent = 'No definitions found';
    } catch(err){
      console.error(err);
      errorEl.textContent = 'Search error: ' + err.message;
      infoEl.textContent = '';
    }
  });
})();
</script>
</body>
</html>